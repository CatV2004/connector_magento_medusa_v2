version: "1.0"
source: "magento"
target: "medusa"
entity: "customer"

fields:
  id:
    target: "metadata.source_id"
    required: false
    type: "string"
    
  email:
    target: "email"
    required: true
    type: "string"
    transform: "clean_email"
    validation:
      pattern: '^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$'
    
  firstname:
    target: "first_name"
    required: true
    type: "string"
    transform: "strip"
    
  lastname:
    target: "last_name"
    required: true
    type: "string"
    transform: "strip"
    
  company:
    target: "company_name"
    required: false
    type: "string"
    transform: "strip"
    
  telephone:
    target: "phone"
    required: false
    type: "string"
    transform: "clean_phone"
    source_paths: ["telephone", "phone"]
    
  # Metadata fields
  group_id:
    target: "metadata.customer_group"
    required: false
    type: "integer"
    
  store_id:
    target: "metadata.store_id"
    required: false
    type: "integer"
    
  website_id:
    target: "metadata.website_id"
    required: false
    type: "integer"
    
  gender:
    target: "metadata.gender"
    required: false
    type: "integer"
    
  taxvat:
    target: "metadata.tax_number"
    required: false
    type: "string"
    
  # Thêm các trường khác cho metadata
  created_at:
    target: "metadata.created_at"
    required: false
    type: "datetime"
    
  updated_at:
    target: "metadata.updated_at"
    required: false
    type: "datetime"

# Custom transformations (chỉ những cái cần cho customer)
transformations:
  clean_email:
    rule: "lower(strip(email))"
    
  clean_phone:
    rule: |
      if phone:
        cleaned = regex_replace(phone, '[^\\d+]', '')
        if not starts_with(cleaned, '+'):
          if length(cleaned) == 10:
            return '+1' + cleaned
          elif length(cleaned) == 11 and starts_with(cleaned, '1'):
            return '+' + cleaned
          else:
            return '+' + cleaned
        else:
          return cleaned
      else:
        return ''
    
  strip:
    rule: "trim(value)"

# Validation rules
validation:
  required_fields: ["email", "firstname", "lastname"]
  unique_fields: ["email"]
  email_validation: true
  phone_validation: false
  max_length:
    email: 255
    first_name: 100
    last_name: 100
    company_name: 200